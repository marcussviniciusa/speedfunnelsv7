# Plano de Desenvolvimento - Sistema de Relat√≥rios para Meta Ads e Google Analytics

## Stack Tecnol√≥gica Aprovada

### Backend
- **Node.js** - Runtime JavaScript
- **Express.js** - Framework web para APIs RESTful
- **MongoDB** - Banco de dados NoSQL
- **Mongoose** - ODM para MongoDB

### Frontend
- **React** - Biblioteca para interface de usu√°rio
- **Vite** - Build tool e dev server
- **React Router** - Roteamento
- **Axios** - Cliente HTTP
- **Chart.js** ou **Recharts** - Visualiza√ß√£o de dados
- **Material-UI** ou **Tailwind CSS** - Framework de UI

### Integra√ß√µes de APIs
- **facebook-nodejs-business-sdk** - SDK oficial Meta Ads
- **@google-analytics/data** - SDK oficial Google Analytics Data API
- **google-auth-library** - Autentica√ß√£o Google

### Autentica√ß√£o e Seguran√ßa
- **JWT** - Tokens de autentica√ß√£o
- **bcryptjs** - Hash de senhas
- **helmet** - Seguran√ßa HTTP

### Exporta√ß√£o de PDF
- **puppeteer** - Gera√ß√£o de PDFs a partir de HTML
- **jspdf** - Biblioteca alternativa para PDF

## Fases de Desenvolvimento

### ‚úÖ Fase 1: Configura√ß√£o Inicial e Estrutura Base
- [x] Inicializa√ß√£o do projeto
- [x] Configura√ß√£o do ambiente de desenvolvimento
- [x] Estrutura de pastas
- [x] Configura√ß√£o do MongoDB
- [x] Setup inicial do Express.js
- [x] Configura√ß√£o b√°sica do React com Vite

### ‚úÖ Fase 2: Sistema de Autentica√ß√£o
- [x] **2.1 Modelos de Dados**
  - [x] Schema de Usu√°rio (MongoDB)
  - [x] Schema de Empresa (MongoDB)
  - [x] Schema de Permiss√µes
  - [x] Relacionamentos entre entidades

- [x] **2.2 Autentica√ß√£o Backend**
  - [x] Middleware de autentica√ß√£o JWT
  - [x] Endpoints de login/logout
  - [x] Middleware de verifica√ß√£o de permiss√µes
  - [x] Sistema de refresh tokens

- [x] **2.3 Interfaces de Autentica√ß√£o**
  - [x] Tela de login
  - [x] Sistema de rotas protegidas
  - [x] Context de autentica√ß√£o React
  - [x] Middleware de redirecionamento

- [x] **2.4 Gerenciamento de Usu√°rios (Super Admin)**
  - [x] CRUD de empresas
  - [x] CRUD de usu√°rios
  - [x] Atribui√ß√£o de permiss√µes
  - [x] Interface administrativa (Backend)

### ‚úÖ Fase 3: Integra√ß√£o com APIs Externas
- [x] **3.1 Integra√ß√£o Meta Ads**
  - [x] Configura√ß√£o do facebook-nodejs-business-sdk
  - [x] Endpoint para configurar conta Meta Ads
  - [x] Valida√ß√£o de credenciais Meta
  - [x] Coleta de dados de campanhas
  - [x] Sistema de cache de dados

- [x] **3.2 Integra√ß√£o Google Analytics (GA4 Data API)**
  - [x] Service Account configura√ß√£o
  - [x] Autentica√ß√£o com JSON credentials
  - [x] Coleta de dados GA4
  - [x] Sistema de cache de dados
  - [x] **üîß BUG FIX COMPLETO: Upload de arquivo JSON resolvido**
    - [x] Instalado e configurado middleware multer
    - [x] Processamento correto de FormData com arquivos
    - [x] Valida√ß√µes aprimoradas com mensagens espec√≠ficas
    - [x] Corre√ß√£o do erro "dados obrigat√≥rios" mesmo preenchendo todos os campos
    - [x] **SOLU√á√ÉO FINAL: Content-Type no frontend corrigido**
      - [x] Removido Content-Type fixo do axios global
      - [x] Interceptor inteligente para detectar FormData
      - [x] req.body e req.file agora funcionam corretamente
  - [x] **üîß BUG FIX: Super Admin sem Company ID resolvido**
    - [x] Implementada l√≥gica de fallback para primeira empresa ativa
    - [x] Aplicado padr√£o consistente do Meta Ads no Google Analytics
    - [x] Corre√ß√£o em 3 fun√ß√µes: testConnection, getData, removeAccount
    - [x] C√≥digo limpo sem logs tempor√°rios
  - [x] **üîß BUG FIX FINAL: M√©tricas GA4 incompat√≠veis resolvido**
    - [x] Identificada causa raiz: averageSessionDuration + bounceRate = INVALID_ARGUMENT
    - [x] Pesquisa na documenta√ß√£o oficial Google Analytics 4 Data API
    - [x] Removidas m√©tricas problem√°ticas de Dashboard e Reports Controller
    - [x] Sistema agora usa apenas m√©tricas b√°sicas est√°veis: sessions, users, screenPageViews
    - [x] Logs limpos sem erros repetitivos INVALID_ARGUMENT
    - [x] Dashboard e Relat√≥rios carregando dados GA4 perfeitamente
    - [x] **PROTE√á√ÉO TOTAL**: Valida√ß√£o autom√°tica em getAnalyticsData()
      - [x] Lista de m√©tricas seguras implementada (9 m√©tricas aprovadas)
      - [x] Filtragem autom√°tica de m√©tricas incompat√≠veis
      - [x] Logs informativos para m√©tricas removidas
      - [x] Fallback seguro para m√©tricas b√°sicas
      - [x] Sistema 100% imune a erros INVALID_ARGUMENT

- [x] **3.3 Gerenciamento de Integra√ß√µes**
  - [x] Schema para armazenar credenciais (criptografadas)
  - [x] Interface para adicionar/remover contas
  - [x] Valida√ß√£o de conex√µes
  - [x] Status de sa√∫de das integra√ß√µes

### ‚úÖ Fase 4: Dashboard e Visualiza√ß√£o de Dados
- [x] **4.1 Coleta e Processamento de Dados**
  - [x] Normaliza√ß√£o de dados Meta + GA
  - [x] Sistema de sincroniza√ß√£o peri√≥dica
  - [x] Agrega√ß√£o de m√©tricas
  - [x] Estrutura de dados unificada

- [x] **4.2 Interface de Dashboard B√°sica**
  - [x] Dashboard com gr√°ficos funcionais
  - [x] M√©tricas principais (gastos, impress√µes, sess√µes)
  - [x] Filtros por per√≠odo
  - [x] **Sele√ß√£o de data personalizada implementada:**
    - [x] Componente CustomDatePicker criado
    - [x] Per√≠odos pr√©-definidos (Hoje, Ontem, 7/30/90 dias, Este/√öltimo m√™s)
    - [x] Calend√°rio personalizado com react-datepicker
    - [x] Integra√ß√£o com Material-UI e estiliza√ß√£o customizada
    - [x] Suporte a datas relativas e formato YYYY-MM-DD
    - [x] Backend atualizado para novos per√≠odos (thisMonth, lastMonth)
    - [x] Implementado no Dashboard e Sistema de Relat√≥rios
    - [x] **üîß BUG FIX: Corre√ß√£o de fuso hor√°rio implementada**
      - [x] Fun√ß√£o parseLocalDate() criada para evitar problemas de UTC
      - [x] Datas agora correspondem exatamente ao selecionado pelo usu√°rio
      - [x] Corre√ß√£o validada com testes (ex: 17/03/2025 agora fica 17/03/2025)
  - [x] Layout responsivo
  - [x] Resolu√ß√£o autom√°tica de empresa para super admin

- [x] **4.3 Visualiza√ß√µes e Gr√°ficos**
  - [x] Componentes de gr√°ficos com Recharts
  - [x] Gr√°ficos de barras para compara√ß√£o
  - [x] Cards de m√©tricas principais
  - [x] Filtros din√¢micos b√°sicos
  - [x] Formata√ß√£o de moeda e n√∫meros

- [x] **4.4 Salvamento de Configura√ß√µes**
  - [x] Sistema de templates de dashboard
  - [x] Configura√ß√µes espec√≠ficas por usu√°rio
  - [x] Configura√ß√µes por cliente/empresa
  - [x] Versionamento de templates

- [ ] **4.5 Editor Avan√ßado (Futuro)**
  - [ ] Interface drag-and-drop para widgets
  - [ ] Seletor de m√©tricas customiz√°veis
  - [ ] Preview em tempo real
  - [ ] Compara√ß√£o entre per√≠odos

### ‚úÖ Fase 5: Sistema de Relat√≥rios
- [x] **5.1 Gera√ß√£o de Relat√≥rios**
  - [x] Sistema de filtros avan√ßados com QueryBuilder drag-and-drop
  - [x] Segmenta√ß√£o de dados por Meta Ads e Google Analytics
  - [x] 6 relat√≥rios pr√©-definidos configurados
  - [x] Interface de relat√≥rios personalizados com 3 abas
  - [x] 4 endpoints backend: generate, fields, predefined, segmentation-options
  - [x] Middleware requirePermission implementado

- [x] **5.2 An√°lise e Visualiza√ß√£o**
  - [x] Sele√ß√£o de contas Meta Ads e perfis Google Analytics
  - [x] Visualiza√ß√£o consolidada com gr√°ficos Recharts
  - [x] Compara√ß√£o entre contas e campanhas
  - [x] Tabelas detalhadas com dados Meta Ads e GA
  - [x] Gr√°ficos: BarChart, AreaChart, LineChart
  - [x] Cards de m√©tricas resumidas (gasto, sess√µes, ROI, campanhas)
  - [x] Sistema de filtros por per√≠odo, tipo de relat√≥rio, segmenta√ß√£o

### üìã Fase 6: Exporta√ß√£o em PDF
- [ ] **6.1 Engine de PDF**
  - [ ] Configura√ß√£o do Puppeteer
  - [ ] Templates HTML para PDF
  - [ ] Renderiza√ß√£o de gr√°ficos em PDF
  - [ ] Preserva√ß√£o de layouts customizados

- [ ] **6.2 Editor de Relat√≥rio PDF**
  - [ ] Interface para sele√ß√£o de componentes
  - [ ] Preview do PDF antes da exporta√ß√£o
  - [ ] Configura√ß√£o de layout
  - [ ] Templates reutiliz√°veis

- [ ] **6.3 Personaliza√ß√£o Visual**
  - [ ] Upload de logotipo da empresa
  - [ ] Cores personalizadas
  - [ ] Cabe√ßalhos e rodap√©s customizados
  - [ ] Formata√ß√£o de texto

### üìã Fase 7: Compartilhamento Controlado
- [ ] **7.1 Sistema de Links**
  - [ ] Gera√ß√£o de links tempor√°rios
  - [ ] Configura√ß√£o de expira√ß√£o
  - [ ] Controle de acesso
  - [ ] Log de acessos

- [ ] **7.2 Distribui√ß√£o de Relat√≥rios**
  - [ ] Envio por email
  - [ ] Download direto
  - [ ] Versionamento de relat√≥rios

## Detalhamento T√©cnico por Integra√ß√£o

### Meta Ads Integration (Facebook Business SDK)
```javascript
// Configura√ß√£o baseada na documenta√ß√£o atual
const adsSdk = require('facebook-nodejs-business-sdk');
const accessToken = process.env.META_ACCESS_TOKEN;
const api = adsSdk.FacebookAdsApi.init(accessToken);

// Coleta de dados de campanhas
const AdAccount = adsSdk.AdAccount;
const Campaign = adsSdk.Campaign;
const account = new AdAccount('act_<AD_ACCOUNT_ID>');

// Pagina√ß√£o autom√°tica para grandes volumes
const campaigns = await account.getCampaigns([
  Campaign.Fields.name,
  Campaign.Fields.status,
  Campaign.Fields.spend,
  Campaign.Fields.impressions
], { limit: 100 });
```

### Google Analytics Integration (GA4 Data API)
```javascript
// Configura√ß√£o baseada na documenta√ß√£o atual
const { BetaAnalyticsDataClient } = require('@google-analytics/data');

// Autentica√ß√£o via Service Account
const analyticsDataClient = new BetaAnalyticsDataClient({
  keyFilename: 'path/to/service-account-key.json'
});

// Coleta de dados GA4
const [response] = await analyticsDataClient.runReport({
  property: `properties/${propertyId}`,
  dateRanges: [{ startDate: '30daysAgo', endDate: 'today' }],
  dimensions: [{ name: 'country' }, { name: 'city' }],
  metrics: [{ name: 'activeUsers' }, { name: 'sessions' }]
});
```

## Estrutura de Arquivos Planejada

```
speedfunnels/
‚îú‚îÄ‚îÄ backend/
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ controllers/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ companies.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ users.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ metaAds.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ googleAnalytics.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dashboard.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ reports.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ User.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Company.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MetaAccount.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ GAAccount.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Dashboard.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ middleware/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ permissions.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ metaAdsService.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ googleAnalyticsService.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ pdfService.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dashboard.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ reports.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ app.js
‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îî‚îÄ‚îÄ .env.example
‚îú‚îÄ‚îÄ frontend/
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Auth/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Dashboard/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Admin/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Reports/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ contexts/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ App.jsx
‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îî‚îÄ‚îÄ vite.config.js
‚îú‚îÄ‚îÄ funcionalidades.md
‚îú‚îÄ‚îÄ plan-dev.md
‚îî‚îÄ‚îÄ README.md
```

## Cronograma Estimado

- **Fase 1**: 3-5 dias
- **Fase 2**: 7-10 dias  
- **Fase 3**: 10-14 dias
- **Fase 4**: 14-18 dias
- **Fase 5**: 7-10 dias
- **Fase 6**: 10-12 dias
- **Fase 7**: 5-7 dias

**Total Estimado**: 56-76 dias de desenvolvimento

## Pr√≥ximos Passos Imediatos

1. **Configurar MongoDB** - Criar cluster e configurar conex√£o
2. **Setup inicial Express.js** - Estrutura b√°sica da API
3. **Configurar React com Vite** - Interface base
4. **Implementar autentica√ß√£o JWT** - Sistema de login b√°sico
5. **Testar integra√ß√µes Meta e Google** - Validar conectividade

## Considera√ß√µes de Seguran√ßa

- Criptografia de credenciais no banco de dados
- Valida√ß√£o de entrada em todas as APIs
- Rate limiting para APIs externas
- Logs de auditoria para a√ß√µes sens√≠veis
- HTTPS obrigat√≥rio em produ√ß√£o
- Sanitiza√ß√£o de dados de entrada

## Observa√ß√µes T√©cnicas

- Usar vari√°veis de ambiente para todas as credenciais
- Implementar sistema de cache para reduzir calls nas APIs
- Considerar implementa√ß√£o de fila para processamento de dados
- Otimizar queries do MongoDB com √≠ndices apropriados
- Implementar monitoramento de sa√∫de das integra√ß√µes 